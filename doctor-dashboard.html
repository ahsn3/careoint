<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Doctor Dashboard - Care Point</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        .dashboard-container {
            min-height: 100vh;
            padding: 100px 20px 40px;
            background: #f8fafc;
        }
        
        .dashboard-header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .dashboard-header h1 {
            color: #1e40af;
            margin-bottom: 10px;
        }
        
        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
        }
        
        .stat-icon.patients { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .stat-icon.appointments { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .stat-icon.today { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        
        .stat-info h3 {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }
        
        .stat-info .stat-value {
            color: #1e40af;
            font-size: 2rem;
            font-weight: 700;
        }
        
        .patients-section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .section-title {
            color: #1e40af;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }
        
        .patients-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .patients-table th {
            background: #f1f5f9;
            padding: 15px;
            text-align: left;
            color: #1e40af;
            font-weight: 600;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .patients-table td {
            padding: 15px;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .patients-table tr:hover {
            background: #f8fafc;
        }
        
        .patient-name {
            font-weight: 600;
            color: #1e40af;
        }
        
        .view-btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.3s;
        }
        
        .view-btn:hover {
            background: #2563eb;
        }
        
        .patient-detail-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            overflow-y: auto;
        }
        
        .modal-content {
            background: white;
            margin: 50px auto;
            padding: 30px;
            border-radius: 15px;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .modal-header h2 {
            color: #1e40af;
            margin: 0;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
        }
        
        .patient-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .detail-item {
            padding: 15px;
            background: #f8fafc;
            border-radius: 8px;
        }
        
        .detail-label {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }
        
        .detail-value {
            color: #1e40af;
            font-weight: 600;
        }
        
        .appointments-list {
            margin-top: 25px;
        }
        
        .appointment-item {
            padding: 15px;
            background: #f8fafc;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #3b82f6;
        }
        
        .no-data {
            text-align: center;
            padding: 40px;
            color: #666;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="logo-section">
                <a href="index.html" class="logo">
                    <i class="fas fa-heartbeat"></i>
                    <span class="logo-text">Care Point</span>
                </a>
                <p class="slogan" data-en="Your Health, Our Priority" data-ar="صحتك، أولويتنا" data-tr="Sağlığınız, Önceliğimiz">Your Health, Our Priority</p>
            </div>
            
            <ul class="main-nav">
                <li><a href="index.html" class="nav-link" data-en="Home" data-ar="الرئيسية" data-tr="Ana Sayfa">Home</a></li>
                <li><a href="doctor-dashboard.html" class="nav-link active" data-en="Dashboard" data-ar="لوحة التحكم" data-tr="Kontrol Paneli">Dashboard</a></li>
            </ul>
            
            <div class="header-actions">
                <div id="userInfo" style="display: none; margin-right: 15px; color: white; font-size: 0.9rem;">
                    <i class="fas fa-user-md"></i>
                    <span id="userName"></span>
                </div>
                <div id="authButtons" style="display: flex; gap: 10px; align-items: center; margin-right: 15px;">
                    <!-- Auth buttons will be inserted here by JavaScript -->
                </div>
                <div class="language-select-wrapper">
                    <select class="language-select" id="languageSelect">
                        <option value="ar">العربية</option>
                        <option value="en">English</option>
                        <option value="tr">Türkçe</option>
                    </select>
                </div>
            </div>
        </div>
    </header>

    <div class="dashboard-container">
        <div class="container">
            <div class="dashboard-header">
                <h1 data-en="Doctor Dashboard" data-ar="لوحة تحكم الطبيب" data-tr="Doktor Kontrol Paneli">Doctor Dashboard</h1>
                <p data-en="Manage and view patient information" data-ar="إدارة وعرض معلومات المرضى" data-tr="Hasta bilgilerini görüntüleyin ve yönetin">Manage and view patient information</p>
            </div>
            
            <div class="dashboard-stats">
                <div class="stat-card">
                    <div class="stat-icon patients">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="stat-info">
                        <h3 data-en="Total Patients" data-ar="إجمالي المرضى" data-tr="Toplam Hasta">Total Patients</h3>
                        <div class="stat-value" id="totalPatients">0</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon appointments">
                        <i class="fas fa-calendar-alt"></i>
                    </div>
                    <div class="stat-info">
                        <h3 data-en="Total Appointments" data-ar="إجمالي المواعيد" data-tr="Toplam Randevu">Total Appointments</h3>
                        <div class="stat-value" id="totalAppointments">0</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon today">
                        <i class="fas fa-calendar-day"></i>
                    </div>
                    <div class="stat-info">
                        <h3 data-en="Today's Appointments" data-ar="مواعيد اليوم" data-tr="Bugünün Randevuları">Today's Appointments</h3>
                        <div class="stat-value" id="todayAppointments">0</div>
                    </div>
                </div>
            </div>
            
            <!-- Analytics Section -->
            <div class="patients-section" style="margin-bottom: 30px;">
                <h2 class="section-title" data-en="Analytics & Insights" data-ar="التحليلات والرؤى" data-tr="Analitik ve İçgörüler">Analytics & Insights</h2>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                    <div style="background: #f8fafc; padding: 20px; border-radius: 10px;">
                        <h3 style="color: #1e40af; margin-bottom: 15px; font-size: 1.1rem;" data-en="Patients by Gender" data-ar="المرضى حسب الجنس" data-tr="Cinsiyete Göre Hastalar">Patients by Gender</h3>
                        <div id="genderChart" style="min-height: 200px;">
                            <!-- Chart will be populated here -->
                        </div>
                    </div>
                    <div style="background: #f8fafc; padding: 20px; border-radius: 10px;">
                        <h3 style="color: #1e40af; margin-bottom: 15px; font-size: 1.1rem;" data-en="Appointments by Department" data-ar="المواعيد حسب القسم" data-tr="Bölüme Göre Randevular">Appointments by Department</h3>
                        <div id="departmentChart" style="min-height: 200px;">
                            <!-- Chart will be populated here -->
                        </div>
                    </div>
                    <div style="background: #f8fafc; padding: 20px; border-radius: 10px;">
                        <h3 style="color: #1e40af; margin-bottom: 15px; font-size: 1.1rem;" data-en="Recent Registrations" data-ar="التسجيلات الأخيرة" data-tr="Son Kayıtlar">Recent Registrations</h3>
                        <div id="registrationChart" style="min-height: 200px;">
                            <!-- Chart will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="patients-section">
                <h2 class="section-title" data-en="All Patients" data-ar="جميع المرضى" data-tr="Tüm Hastalar">All Patients</h2>
                <div id="patientsTableContainer">
                    <table class="patients-table">
                        <thead>
                            <tr>
                                <th data-en="Name" data-ar="الاسم" data-tr="Ad">Name</th>
                                <th data-en="Email" data-ar="البريد الإلكتروني" data-tr="E-posta">Email</th>
                                <th data-en="Phone" data-ar="الهاتف" data-tr="Telefon">Phone</th>
                                <th data-en="Gender" data-ar="الجنس" data-tr="Cinsiyet">Gender</th>
                                <th data-en="Appointments" data-ar="المواعيد" data-tr="Randevular">Appointments</th>
                                <th data-en="Actions" data-ar="الإجراءات" data-tr="İşlemler">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="patientsTableBody">
                            <!-- Patients will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Patient Detail Modal -->
    <div id="patientDetailModal" class="patient-detail-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 data-en="Patient Details" data-ar="تفاصيل المريض" data-tr="Hasta Detayları">Patient Details</h2>
                <button class="close-modal" id="closeModal">&times;</button>
            </div>
            <div id="patientDetailContent">
                <!-- Patient details will be populated here -->
            </div>
        </div>
    </div>

    <script src="doctors.js"></script>
    <script src="api-client.js"></script>
    <script src="auth-api.js"></script>
    <script src="script.js"></script>
    <script src="sample-data.js"></script>
    <script>
        // Check if user is logged in as doctor
        if (!window.auth || !window.auth.isLoggedIn() || window.auth.getCurrentUserRole() !== 'doctor') {
            window.location.href = 'login.html';
        }
        
        // Initialize sample data first
        if (typeof initializeSampleData === 'function') {
            initializeSampleData();
        }
        
        // Initialize language
        if (typeof initLanguage === 'function') {
            initLanguage();
        }
        
        // Update navigation
        function updateAuthNavigation() {
            const authButtons = document.getElementById('authButtons');
            const userInfo = document.getElementById('userInfo');
            const userName = document.getElementById('userName');
            const lang = window.currentLanguage || 'en';
            
            if (window.auth && window.auth.isLoggedIn()) {
                const user = window.auth.getCurrentUser();
                let displayName = user.email;
                if (user.name) {
                    if (typeof user.name === 'string') {
                        displayName = user.name;
                    } else if (typeof user.name === 'object' && user.name[lang]) {
                        displayName = user.name[lang];
                    } else if (typeof user.name === 'object' && user.name.en) {
                        displayName = user.name.en;
                    }
                }
                
                if (userInfo && userName) {
                    userInfo.style.display = 'block';
                    userName.textContent = displayName;
                }
                
                const logoutText = lang === 'ar' ? 'تسجيل الخروج' : lang === 'tr' ? 'Çıkış Yap' : 'Logout';
                authButtons.innerHTML = `
                    <a href="#" id="logoutBtn" style="color: white; text-decoration: none; padding: 8px 15px; border-radius: 5px; background: rgba(255,255,255,0.2); transition: background 0.3s;" 
                       onmouseover="this.style.background='rgba(255,255,255,0.3)'" 
                       onmouseout="this.style.background='rgba(255,255,255,0.2)'"
                       data-en="Logout" data-ar="تسجيل الخروج" data-tr="Çıkış Yap">${logoutText}</a>
                `;
                
                document.getElementById('logoutBtn').addEventListener('click', function(e) {
                    e.preventDefault();
                    window.auth.logout();
                });
            }
        }
        
        // Load and display patients
        function loadPatients() {
            const patients = window.auth.getPatients();
            const tbody = document.getElementById('patientsTableBody');
            const lang = window.currentLanguage || 'en';
            
            // Update stats
            document.getElementById('totalPatients').textContent = patients.length;
            
            let totalAppointments = 0;
            let todayAppointments = 0;
            const today = new Date().toISOString().split('T')[0];
            
            patients.forEach(patient => {
                if (patient.appointments) {
                    totalAppointments += patient.appointments.length;
                    patient.appointments.forEach(apt => {
                        if (apt.date === today) {
                            todayAppointments++;
                        }
                    });
                }
            });
            
            document.getElementById('totalAppointments').textContent = totalAppointments;
            document.getElementById('todayAppointments').textContent = todayAppointments;
            
            // Clear table
            tbody.innerHTML = '';
            
            if (patients.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="no-data" data-en="No patients registered yet" data-ar="لا يوجد مرضى مسجلون بعد" data-tr="Henüz hasta kaydı yok">No patients registered yet</td>
                    </tr>
                `;
                return;
            }
            
            // Populate table
            patients.forEach(patient => {
                const row = document.createElement('tr');
                const appointmentCount = patient.appointments ? patient.appointments.length : 0;
                const genderText = patient.gender === 'male' 
                    ? (lang === 'ar' ? 'ذكر' : lang === 'tr' ? 'Erkek' : 'Male')
                    : (lang === 'ar' ? 'أنثى' : lang === 'tr' ? 'Kadın' : 'Female');
                
                row.innerHTML = `
                    <td class="patient-name">${patient.name || 'N/A'}</td>
                    <td>${patient.email}</td>
                    <td>${patient.phone || 'N/A'}</td>
                    <td>${genderText}</td>
                    <td>${appointmentCount}</td>
                    <td>
                        <button class="view-btn" onclick="viewPatientDetails(${patient.id})" 
                                data-en="View" data-ar="عرض" data-tr="Görüntüle">View</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // View patient details
        async function viewPatientDetails(patientId) {
            const patients = await window.auth.getPatients();
            const patient = patients.find(p => p.id === patientId);
            const lang = window.currentLanguage || 'en';
            
            if (!patient) return;
            
            const modal = document.getElementById('patientDetailModal');
            const content = document.getElementById('patientDetailContent');
            
            const genderText = patient.gender === 'male' 
                ? (lang === 'ar' ? 'ذكر' : lang === 'tr' ? 'Erkek' : 'Male')
                : (lang === 'ar' ? 'أنثى' : lang === 'tr' ? 'Kadın' : 'Female');
            
            const dateOfBirth = patient.dateOfBirth ? new Date(patient.dateOfBirth).toLocaleDateString() : 'N/A';
            const registeredDate = patient.registeredAt ? new Date(patient.registeredAt).toLocaleDateString() : 'N/A';
            
            content.innerHTML = `
                <div class="patient-details">
                    <div class="detail-item">
                        <div class="detail-label" data-en="Full Name" data-ar="الاسم الكامل" data-tr="Ad Soyad">Full Name</div>
                        <div class="detail-value">${patient.name || 'N/A'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label" data-en="Email" data-ar="البريد الإلكتروني" data-tr="E-posta">Email</div>
                        <div class="detail-value">${patient.email}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label" data-en="Phone" data-ar="الهاتف" data-tr="Telefon">Phone</div>
                        <div class="detail-value">${patient.phone || 'N/A'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label" data-en="Date of Birth" data-ar="تاريخ الميلاد" data-tr="Doğum Tarihi">Date of Birth</div>
                        <div class="detail-value">${dateOfBirth}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label" data-en="Gender" data-ar="الجنس" data-tr="Cinsiyet">Gender</div>
                        <div class="detail-value">${genderText}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label" data-en="Registered Date" data-ar="تاريخ التسجيل" data-tr="Kayıt Tarihi">Registered Date</div>
                        <div class="detail-value">${registeredDate}</div>
                    </div>
                    <div class="detail-item" style="grid-column: 1 / -1;">
                        <div class="detail-label" data-en="Address" data-ar="العنوان" data-tr="Adres">Address</div>
                        <div class="detail-value">${patient.address || 'N/A'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label" data-en="Blood Type" data-ar="فصيلة الدم" data-tr="Kan Grubu">Blood Type</div>
                        <div class="detail-value">${patient.bloodType || 'N/A'}</div>
                    </div>
                    <div class="detail-item" style="grid-column: 1 / -1;">
                        <div class="detail-label" data-en="Allergies" data-ar="الحساسيات" data-tr="Alerjiler">Allergies</div>
                        <div class="detail-value">${patient.allergies || 'None recorded'}</div>
                    </div>
                    <div class="detail-item" style="grid-column: 1 / -1;">
                        <div class="detail-label" data-en="Medical History" data-ar="التاريخ الطبي" data-tr="Tıbbi Geçmiş">Medical History</div>
                        <div class="detail-value">${patient.medicalHistory || 'No medical history recorded'}</div>
                    </div>
                    ${patient.emergencyContact && patient.emergencyContact.name ? `
                    <div class="detail-item" style="grid-column: 1 / -1;">
                        <div class="detail-label" style="font-size: 1.1rem; margin-bottom: 10px;" data-en="Emergency Contact" data-ar="جهة الاتصال في حالات الطوارئ" data-tr="Acil Durum İletişim">Emergency Contact</div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <div>
                                <div class="detail-label" data-en="Name" data-ar="الاسم" data-tr="Ad">Name</div>
                                <div class="detail-value">${patient.emergencyContact.name}</div>
                            </div>
                            <div>
                                <div class="detail-label" data-en="Phone" data-ar="الهاتف" data-tr="Telefon">Phone</div>
                                <div class="detail-value">${patient.emergencyContact.phone || 'N/A'}</div>
                            </div>
                            <div>
                                <div class="detail-label" data-en="Relationship" data-ar="العلاقة" data-tr="İlişki">Relationship</div>
                                <div class="detail-value">${patient.emergencyContact.relationship || 'N/A'}</div>
                            </div>
                        </div>
                    </div>
                    ` : ''}
                </div>
                
                <div class="appointments-list">
                    <h3 style="color: #1e40af; margin-bottom: 15px;" data-en="Appointments" data-ar="المواعيد" data-tr="Randevular">Appointments</h3>
                    ${patient.appointments && patient.appointments.length > 0 
                        ? patient.appointments.map(apt => `
                            <div class="appointment-item">
                                <strong>${apt.doctor || 'N/A'}</strong> - 
                                ${apt.date || 'N/A'} at ${apt.time || 'N/A'}
                                ${apt.notes ? `<br><small>${apt.notes}</small>` : ''}
                            </div>
                        `).join('')
                        : '<div class="no-data" data-en="No appointments yet" data-ar="لا توجد مواعيد بعد" data-tr="Henüz randevu yok">No appointments yet</div>'
                    }
                </div>
            `;
            
            modal.style.display = 'block';
        }
        
        // Close modal
        document.getElementById('closeModal').addEventListener('click', function() {
            document.getElementById('patientDetailModal').style.display = 'none';
        });
        
        window.onclick = function(event) {
            const modal = document.getElementById('patientDetailModal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        }
        
        // Load analytics
        async function loadAnalytics() {
            const patients = await window.auth.getPatients();
            const lang = window.currentLanguage || 'en';
            
            // Gender distribution
            const genderStats = {
                male: patients.filter(p => p.gender === 'male').length,
                female: patients.filter(p => p.gender === 'female').length
            };
            
            const genderChart = document.getElementById('genderChart');
            if (genderChart) {
                const maleText = lang === 'ar' ? 'ذكر' : lang === 'tr' ? 'Erkek' : 'Male';
                const femaleText = lang === 'ar' ? 'أنثى' : lang === 'tr' ? 'Kadın' : 'Female';
                const total = genderStats.male + genderStats.female;
                
                genderChart.innerHTML = `
                    <div style="display: flex; flex-direction: column; gap: 15px;">
                        <div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                <span>${maleText}</span>
                                <span style="font-weight: 600; color: #1e40af;">${genderStats.male}</span>
                            </div>
                            <div style="background: #e2e8f0; height: 20px; border-radius: 10px; overflow: hidden;">
                                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); height: 100%; width: ${total > 0 ? (genderStats.male / total * 100) : 0}%; transition: width 0.5s;"></div>
                            </div>
                        </div>
                        <div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                <span>${femaleText}</span>
                                <span style="font-weight: 600; color: #1e40af;">${genderStats.female}</span>
                            </div>
                            <div style="background: #e2e8f0; height: 20px; border-radius: 10px; overflow: hidden;">
                                <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); height: 100%; width: ${total > 0 ? (genderStats.female / total * 100) : 0}%; transition: width 0.5s;"></div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Department distribution
            const departmentStats = {};
            patients.forEach(patient => {
                if (patient.appointments) {
                    patient.appointments.forEach(apt => {
                        const dept = apt.doctorId ? getDepartmentByDoctorId(apt.doctorId) : 'Other';
                        departmentStats[dept] = (departmentStats[dept] || 0) + 1;
                    });
                }
            });
            
            const departmentChart = document.getElementById('departmentChart');
            if (departmentChart) {
                const departments = Object.keys(departmentStats);
                const maxValue = Math.max(...Object.values(departmentStats), 1);
                
                if (departments.length === 0) {
                    departmentChart.innerHTML = '<p style="color: #666; text-align: center;">' + 
                        (lang === 'ar' ? 'لا توجد بيانات' : lang === 'tr' ? 'Veri yok' : 'No data') + '</p>';
                } else {
                    let chartHTML = '<div style="display: flex; flex-direction: column; gap: 12px;">';
                    departments.forEach(dept => {
                        const count = departmentStats[dept];
                        const percentage = (count / maxValue * 100);
                        chartHTML += `
                            <div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                    <span style="font-size: 0.9rem;">${dept}</span>
                                    <span style="font-weight: 600; color: #1e40af;">${count}</span>
                                </div>
                                <div style="background: #e2e8f0; height: 18px; border-radius: 9px; overflow: hidden;">
                                    <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); height: 100%; width: ${percentage}%; transition: width 0.5s;"></div>
                                </div>
                            </div>
                        `;
                    });
                    chartHTML += '</div>';
                    departmentChart.innerHTML = chartHTML;
                }
            }
            
            // Registration trend (last 7 days)
            const registrationChart = document.getElementById('registrationChart');
            if (registrationChart) {
                const last7Days = [];
                const today = new Date();
                for (let i = 6; i >= 0; i--) {
                    const date = new Date(today);
                    date.setDate(date.getDate() - i);
                    last7Days.push(date.toISOString().split('T')[0]);
                }
                
                const registrationsByDay = last7Days.map(date => {
                    return patients.filter(p => {
                        if (!p.registeredAt) return false;
                        const regDate = new Date(p.registeredAt).toISOString().split('T')[0];
                        return regDate === date;
                    }).length;
                });
                
                const maxReg = Math.max(...registrationsByDay, 1);
                
                registrationChart.innerHTML = `
                    <div style="display: flex; align-items: flex-end; gap: 8px; height: 150px;">
                        ${last7Days.map((date, index) => {
                            const count = registrationsByDay[index];
                            const height = (count / maxReg * 100);
                            const dayName = new Date(date).toLocaleDateString(lang === 'ar' ? 'ar-EG' : lang === 'tr' ? 'tr-TR' : 'en-US', { weekday: 'short' });
                            return `
                                <div style="flex: 1; display: flex; flex-direction: column; align-items: center; gap: 5px;">
                                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); width: 100%; height: ${height}%; border-radius: 5px 5px 0 0; min-height: ${count > 0 ? '5px' : '0'}; transition: height 0.5s;"></div>
                                    <div style="font-size: 0.75rem; color: #666; text-align: center;">${dayName}</div>
                                    <div style="font-size: 0.85rem; font-weight: 600; color: #1e40af;">${count}</div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            }
        }
        
        // Helper function to get department by doctor ID
        function getDepartmentByDoctorId(doctorId) {
            if (typeof doctors !== 'undefined') {
                const doctor = doctors.find(d => d.id === doctorId);
                if (doctor) {
                    const lang = window.currentLanguage || 'en';
                    return doctor.departmentName[lang] || doctor.departmentName['en'] || 'Other';
                }
            }
            return 'Other';
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', async function() {
            updateAuthNavigation();
            await loadPatients();
            await loadAnalytics();
        });
        
        // Reload when language changes
        const languageSelect = document.getElementById('languageSelect');
        if (languageSelect) {
            languageSelect.addEventListener('change', function() {
                setTimeout(() => {
                    loadPatients();
                    updateAuthNavigation();
                    loadAnalytics();
                }, 100);
            });
        }
    </script>
</body>
</html>

